@model DAMH.Models.Chapter

@{
    ViewData["Title"] = Model.Title;
    var isAdminView = ViewBag.IsAdminView ?? false;
    var previousChapterId = ViewBag.PreviousChapterId as int?;
    var nextChapterId = ViewBag.NextChapterId as int?;
    var allChapters = ViewBag.AllChapters as List<DAMH.Models.Chapter>;
}

<div class="container-fluid mt-3">
    <div class="reading-toolbar sticky-top bg-white shadow-sm py-3 mb-4" style="z-index: 1000;">
        <div class="container">
            <div class="row align-items-center g-2">
                <div class="col-auto">
                    @if (isAdminView)
                    {
                        <a asp-controller="Admin" asp-action="ViewBookChapters" asp-route-bookId="@Model.BookId" class="btn btn-outline-danger">
                            <i class="bi bi-arrow-left"></i> Về trang Admin
                        </a>
                    }
                    else
                    {
                        <a asp-controller="Home" asp-action="Details" asp-route-id="@Model.BookId" class="btn btn-outline-primary">
                            <i class="bi bi-arrow-left"></i> Mục lục
                        </a>
                    }
                </div>

                <div class="col-md-4">
                    <select class="form-select" onchange="window.location.href='@Url.Action("ViewChapter", "Reading")?chapterId=' + this.value + '&isAdminView=@isAdminView'">
                        @if (allChapters != null)
                        {
                            foreach (var chapter in allChapters)
                            {
                                <option value="@chapter.ChapterId" selected="@(chapter.ChapterId == Model.ChapterId)">
                                    Chương @chapter.ChapterOrder: @chapter.Title
                                </option>
                            }
                        }
                    </select>
                </div>

                <div class="col-auto">
                    @if (previousChapterId.HasValue)
                    {
                        <a asp-action="ViewChapter" asp-route-chapterId="@previousChapterId" asp-route-isAdminView="@isAdminView" class="btn btn-outline-secondary">
                            <i class="bi bi-chevron-left"></i> Trước
                        </a>
                    }
                    else
                    {
                        <button class="btn btn-outline-secondary" disabled><i class="bi bi-chevron-left"></i> Trước</button>
                    }
                </div>

                <div class="col-auto">
                    @if (nextChapterId.HasValue)
                    {
                        <a asp-action="ViewChapter" asp-route-chapterId="@nextChapterId" asp-route-isAdminView="@isAdminView" class="btn btn-primary">
                            Sau <i class="bi bi-chevron-right"></i>
                        </a>
                    }
                    else
                    {
                        <button class="btn btn-secondary" disabled>Sau <i class="bi bi-chevron-right"></i></button>
                    }
                </div>

                <div class="col-auto ms-auto">
                    @if (User.Identity?.IsAuthenticated == true)
                    {
                        <button class="btn btn-outline-danger favorite-btn"
                                data-book-id="@Model.BookId"
                                onclick="toggleFavorite(@Model.BookId, this)">
                            <i class="bi bi-heart"></i> Yêu thích
                        </button>
                    }
                    else
                    {
                        <a asp-controller="Account" asp-action="Login" class="btn btn-outline-secondary">
                            <i class="bi bi-heart"></i> Yêu thích
                        </a>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-9">
                <div class="card shadow-lg border-0 mb-5">
                    <div class="card-body p-5">
                        <h2 class="text-center mb-1 text-primary">@Model.Book.Title</h2>
                        <h4 class="text-center text-muted mb-4">@Model.Title</h4>
                        <hr />

                        <div class="chapter-content mt-4" style="font-size: 1.3rem; line-height: 1.8; text-align: justify;">
                            @Html.Raw(Model.Content)
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            checkFavoriteStatus();
        });

        function checkFavoriteStatus() {
            var bookId = $('.favorite-btn').data('book-id');
            if (!bookId) return;

            $.get('/Favorites/CheckStatus', { bookId: bookId }, function(response) {
                var btn = $('.favorite-btn[data-book-id="' + bookId + '"]');
                if (response.isFavorited) {
                    btn.removeClass('btn-outline-danger').addClass('btn-danger');
                    btn.find('i').removeClass('bi-heart').addClass('bi-heart-fill');
                } else {
                    btn.removeClass('btn-danger').addClass('btn-outline-danger');
                    btn.find('i').removeClass('bi-heart-fill').addClass('bi-heart');
                }
            });
        }

        function toggleFavorite(bookId, button) {
            $.post('/Favorites/Toggle', { bookId: bookId }, function(response) {
                if (response.success) {
                    var btn = $(button);
                    if (response.isFavorited) {
                        btn.removeClass('btn-outline-danger').addClass('btn-danger');
                        btn.find('i').removeClass('bi-heart').addClass('bi-heart-fill');
                    } else {
                        btn.removeClass('btn-danger').addClass('btn-outline-danger');
                        btn.find('i').removeClass('bi-heart-fill').addClass('bi-heart');
                    }

                    showNotification(response.message, 'success');
                } else {
                    showNotification(response.message, 'error');
                }
            }).fail(function() {
                showNotification('Có lỗi xảy ra. Vui lòng thử lại!', 'error');
            });
        }

        function showNotification(message, type) {
            var alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            var notification = $('<div class="alert ' + alertClass + ' alert-dismissible fade show position-fixed" style="top: 20px; right: 20px; z-index: 9999;" role="alert">' +
                message +
                '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                '</div>');

            $('body').append(notification);
            setTimeout(function() {
                notification.alert('close');
            }, 3000);
        }
    </script>
}